---
title: S&P 500 Price Change Predictors
author:
- Andy Barnes
- Ryan Leveille
- Tong Sun
- Jared Turner
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
- \usepackage{amssymb}
- \usepackage{amsthm}
- \usepackage{graphicx}
- \newcommand{\Lim}[1]{\raisebox{0.5ex}{\scalebox{0.8}{$\displaystyle \lim_{#1}\;$}}}
output:
 pdf_document:
  latex_engine: xelatex
linkcolor: blue
---

```{r global.options, include = TRUE, echo=FALSE}
knitr::opts_chunk$set(
    cache       = TRUE,     # if TRUE knitr will cache the results to reuse in future knits
    fig.width   = 5,       # the width for plots created by code chunk
    fig.height  = 3.5,       # the height for plots created by code chunk
    fig.align   = 'center', # how to align graphics in the final doc. 'left', 'right', 'center'
    fig.path    = 'figs/',  # file path to the directory where knitr shall store the graphics files
    echo        = TRUE,     # in FALSE knitr will not display code in the code chunk above it's results
    message     = TRUE,     # if FALSE knitr will not display any messages generated by code
    strip.white = TRUE,     # if FALSE knitr will not remove white spaces at the beg or end of code chunk
    warning     = FALSE)    # if FALSE knitr will not display any warning messages in the final document
```

# Project Scope

## S&P 500

The Standard & Poor's 500, often abbreviated as the S&P 500, or just the S&P, is an American stock market index based on the market capitalizations of 500 large companies having common stock listed on the NYSE or NASDAQ. The NYSE and NASDAQ are the American stock exchanges where the stocks that make up the S&P 500 are traded. Market capitalization (market cap) is the market value of a publicly traded company's outstanding shares. Market capitalization is equal to the share price multiplied by the number of shares outstanding. As outstanding stock is bought and sold in public markets, capitalization could be used as an indicator of public opinion of a company's net worth and is a determining factor in some forms of stock valuation. The reason that we chose to use the S&P 500 for our companies is that it is a very broad and diversified index that includes companies from many different industries. The S&P 500 is one of the most commonly followed equity indices, and many consider it one of the best representations of the U.S. stock market, and a bellwether for the U.S. economy. The share prices for each company within the S&P 500 change daily (during trading days) based on trading interest. A share price is the price of a single share of a company, derivative or other financial asset. The share price is the highest amount someone is willing to pay for the stock, or the lowest amount that it can be bought for.

## Time Frame

Our project is going to analyze the companies within the S&P 500 over a 7 year period. This period is going to be from 1/01/2011-12/31/2017.

Approach:

Due to the volatility of the stock market and how the data can sometimes be very misleading depending upon the time frame which you choose to analyze the data from, we are going to approach this project with the intention of minimizing any major outliers for our response variable (share price).

For example, if we were to randomly select some date in 2011 and observe the share price for Microsoft it could be $50 per share. Likewise if we took another random date in 2011 to observe the price of Microsoft it could be $25 per share, perhaps even just a week before or after the price was at $50 per share. Furthermore, when we analyze the response variable in 2017 it could be $50 or $25, depending on the time frame you select for the observation.

Therefore, the way that we will make sure that we do not misrepresent our response variable and by keeping the project within the scope of our class we will be taking the average of the share price for each company within the S&P 500 for the years 2011 and 2017. The 5 years in between (2012, 2013, 2014, 2015, 2016) will allow plenty of time for our response variable to change based on our predictor variables.

Another reason why we want to calculate the average share price for each company by year is because our predictor variables will be yearly as well.

The S&P 500 is based on market cap and some companies will grow in size or fall in size so we will be using companies that were in the S&P 500 starting on January 1, 2011, and are still in the S&P 500 on December 31, 2017. As of now, we have 476 companies out of 500 that are still within the S&P 500 to analyze.

## Response Variable

Share Price (Y): Our response variable is going to be the share price of each company within the S&P 500. We are going to take the average share price for 2011 and the average share price for 2017 and then calculate the percent difference for each company.

## Predictor Variables

We have multiple variables that we are going to use as our predictor variables. These variables have been chosen based on what what we think investors use to analyze a company before making an investment. Also, some other potential variables' data is incomplete or missing so we choose variables that were best for the scope of the project.

Our goal with this project is to find the predictor variables that have the biggest impact on our response variable (share price).

All of our variables are going to be using their percent change in yearly unit during our time period of 2011-2017. We will start with the predictor variables' 2011 observations and end with the predictor variables' 2017 observations. We chose this time frame because it gave us our yearly data of 2011, a 5 year time frame, then our yearly data of 2017.

1. Earnings per Share: Earnings per share (EPS) is the portion of a company's profit allocated to each share of common stock. Earnings per share serves as an indicator of a company's profitability.

2. Dividend: A dividend is a payment made by a corporation to its shareholders, usually as a distribution of profits. When a corporation earns a profit or surplus, the corporation is able to re-invest the profit in the business and pay a proportion of the profit as a dividend to shareholders.

3. Book Value per Share: Book value per share indicates the book value (or accounting value) of each share of stock. Book value is a company's net asset value, which is calculated by total assets minus intangible assets and liabilities. An easy way to think of book value per share is what is the expected value of the company.

4. Return on Assets: The return on assets shows the percentage of how profitable a company's assets are in generating revenue.

5. Return on Equity: Return on equity is a measure of the profitability of a business in relation to the book value of shareholder equity, also known as net assets or assets minus liabilities. ROE is a measure of how well a company uses investments to generate earnings growth.

6. Return on Invested Capital: Return on capital (ROC), or return on invested capital(ROIC), is a ratio used in finance, valuation and accounting, as a measure of the profitability and value-creating potential of companies after taking into account the amount of initial capital invested.

7. Debt / Equity: Debt/Equity (D/E) Ratio, calculated by dividing a company's total liabilities by its stockholders' equity, is a debt ratio used to measure a company's financial leverage. The D/E ratio indicates how much debt a company is using to finance its assets relative to the value of shareholders' equity.

8. Revenue: Revenue is the income that a business has from its normal business activities, usually from the sale of goods and services to customers.


# The Data

Our data looks at the $476$ stocks in in the S&P 500 today with data dating back to 2011. Each variable is given as the percent change in yearly value or average value from 2011 to 2017. The first $6$ rows of data are as follows


```{r echo=FALSE}
load("linear_project_data_plot_cor.Rda")
head(full_data)
```
from this we can obtain a correlation matrix

```{r echo=FALSE}
knitr::kable(cor.matrix[,1:3], format="markdown")
knitr::kable(cor.matrix[,4:6], format="markdown")
knitr::kable(cor.matrix[,7:9], format="markdown")
```

and scatterplot.

```{r , echo=FALSE, fig.width=8, fig.height=6}
plot(full_data[-1], main = 'Scatter Plot for Variables')
```

# Why we chose this data

We chose this project due to the vast amounts of data that the stock market encompasses. The stock market is a very broad topic and this project can be applied to many different situations.

With our project we hope to find which predictor variables affect the response variable (share price) the most. We are excited to see what our models come up with. The findings will be interesting as there are many different theories as to what is the most important predictor variables for a companies share price.


## Current Progress

Before we were able to run a multiple linear regression we had to clean our data and replace the `NA`'s. For the predictor variable `Dividends` the `NA`'s were replaced with 0 because this meant that the company (stock) did not have a dividend payment. For the other predictor variables, the `NA` was replaced with means. For this cleaned data we obtain the correlation matrix and scatterplot.

```{r, echo=FALSE, fig.width=6, fig.height=6}
# Replace NAs with mean of the column
clean_data <- full_data[, -1]
for (i in 1:ncol(clean_data)){
  clean_data[is.na(clean_data[, i]), i] <- mean(clean_data[, i], na.rm = T)
}
# Better cor matrix
cor.matrix.cleaned <- cor(clean_data)
cor.matrix.cleaned
plot(clean_data, main = 'Scatter Plot for Variables (Cleaned)')
```

After this, our initial attempt was to take our data and run a multiple linear regression on it. The summary is as follows.

```{r, echo=FALSE, fig.width=8, fig.height=5}
full.model <- lm(Delta.price ~ ., data = clean_data)
summary(full.model)
rsq <- summary(full.model)$r.squared
```

We recorded an Rsquared value of $`r rsq`$ and had multiple predictors that were deemed insignificant by minimizing AIC via R's `step` function. Minimizing AIC will optiminize quality and minimize the complexity. Due to this, we ran a stepwise function to limit our data to just the significant predictors. The significant predictors that we ended up with were `Dividends.USD`, `Return on Invested Capital`, `Debt/Equity`, `Revenue`. We then obtained the following reduced linear model.


```{r, echo=FALSE, fig.width=7, fig.height=5}
# Backward elimination method:
# Dropping variables to minimize AIC (quality of fitting & complexity of the model)
reduced.model <- step(full.model, direction = 'backward') # same result as 'forward'
summary(reduced.model)
anova(reduced.model)
```

By looking at the correlations between the 4 predictors, they are very independent with each other. We can see this by looking at the correlation matrix and its relevant heat map.

```{r, echo=FALSE, fig.width=7, fig.height=5}
reduced.cor.matrix <- cor(clean_data[ , c(3,7,8,9)]) # Good, predictors are not highly correlated
reduced.cor.matrix
library(RColorBrewer)
heatmap(cor.matrix.cleaned, col=brewer.pal(9,"Greys"), cexRow = 0.7, cexCol = 0.7,
        Rowv = NA, symm = T, reorderfun = NULL, margins = c(8,8), main = 'cor.matrix.cleaned')
```

We are going to continue to explore our data and see if we can potentially use different predictor variables and/or a polynomial regression to fit our data better. Additionally, we will explore other methods to replace the `NA`'s which could give our model a higher Rsquared. But first, we will see if there are any outliers.


## Checking for outliers


```{r}
hist(clean_data$Delta.price)
par(mfrow=c(1,2))
plot(full.model, which=c(1:2), pch=20)
```

```{r}
dropped <- c(-6,-333,-404,-14,-214,
                  -27,-2,-127,-287,
                  -384,-426,-49,-181,
                  -43,-28,-149,-39,
                  -50, -320, -326,
                  -9, -119, -440,
                  -78,-148, -29,-389,
                  -21, -75, -297, -233)
length(dropped)
full.model.drop <- lm(Delta.price ~ ., data = clean_data, subset=dropped)



par(mfrow=c(1,2))
plot(full.model.drop, which=c(1:2), pch=20)
summary(full.model.drop)
```




```{r}
hist(clean_data$Delta.price[dropped])
reduced.model.drop <- step(full.model.drop, direction = 'backward')
summary(reduced.model.drop)
anova(reduced.model.drop)
full_data$Company[-1*dropped]
```









